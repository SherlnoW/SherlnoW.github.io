---
layout: post
title: 【实习】慢SQL优化分析
date: 2023-06-03 13:00
description: 慢SQL优化分析
tag:
- 慢SQL
---

# 慢SQL

慢SQL指的是执行时间较长的数据库查询语句。具体而言，当一个SQL语句的执行时间超过了预期或系统的性能要求，就可以称之为慢SQL。
慢SQL可能会导致系统响应变慢、用户等待时间增加，甚至引发系统崩溃等问题。

> PMS中定义查询时间超过1s的SQL为慢SQL

# 如何排查慢SQL

### 监控工具

使用专业的数据库监控工具，可以实时追踪数据库的性能指标，包括慢查询日志、锁等待情况、数据库连接数等。通过监控工具，我们可以快速定位问题SQL，并对其进行分析和优化。

> 使用腾讯自研工具连接数据库进行监控

### 慢查询日志

数据库通常会记录慢查询日志，其中包含执行时间超过设定阈值的SQL语句。通过查看慢查询日志，我们可以获得执行时间较长的SQL语句列表，从而找出潜在的性能瓶颈。

### Explain

使用数据库的Explain工具，可以获取SQL语句的执行计划。执行计划包括了数据库查询优化器的执行策略，可以帮助我们理解SQL语句是如何执行的，是否存在索引失效、全表扫描等问题。

# 常见的慢SQL原因分析

### 缺乏索引

缺乏合适的索引是导致慢SQL的常见原因之一。分析方法包括：

- 使用数据库性能分析工具来分析查询计划，查看是否存在全表扫描或索引失效情况。
- 根据查询频率和业务需求，添加适当的索引。

### 2. 复杂查询语句

复杂的查询语句容易导致性能下降。分析方法包括：

- 检查查询语句中是否包含子查询、JOIN过多等复杂操作。
- 分解复杂查询为多个简单查询，避免不必要的计算和IO操作。

### 3. 数据库参数配置

数据库参数的配置也可能影响SQL的执行速度。分析方法包括：

- 检查数据库的配置参数，如缓冲区大小、连接数等。
- 根据实际需求调整参数值，以获得最佳性能。

# 常见的慢SQL优化方法

### 使用索引

索引是加速数据库查询的重要工具。通过合理创建和使用索引，可以显著提高查询性能。优化方法包括：

- 确保关键字段上创建了适当的索引。
- 避免过多的索引，避免过度索引导致写入性能下降。
- 对复合索引进行适当的排序，以最大程度地减少索引扫描。

### 优化查询语句

合理编写查询语句可以减少查询的时间复杂度。优化方法包括：

- 减少不必要的字段选择，只选择需要的字段。
- 使用合适的JOIN和子查询来避免重复数据的返回。
- 避免使用SELECT *，而是明确列出所需字段。

### 数据库结构优化

数据库的结构设计也对性能有影响。优化方法包括：

- 合理设计表之间的关系，避免过度范式化或反范式化。
- 使用合适的数据类型和字段长度，避免浪费存储空间。
- 考虑分表、分区等方案以减轻单表的负载。

# 部分慢SQL记录

**示例1: 索引缺失**

在风险中台功能模块中，查询时一定会对字段`question_status`进行筛选，但此字段没有索引，发生全表扫描，已追加索引,执行SQL扫描数量量级从5千行降至300

**示例2: 类型不匹配**

```sql
    SELECT * FROM `resource`
    WHERE `source_value` = 752 -- 发生了全表扫描152676行数据 字段"source_value"与参数类型不匹配,隐式转换导致条件不能使用索引
        AND `en_name` = 'hunterxiao'
        AND `source_type` = 2
    LIMIT 1
```

**where IN大量数据**

```sql

```
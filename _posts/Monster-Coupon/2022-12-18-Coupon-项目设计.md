---
layout: post
title: 【项目】Coupon-项目设计
date: 2022-12-18 13:00
description: 项目设计
tag:
- 项目
- Coupon
- 微服务
- Java
---

# Coupon-项目设计

### 学习目标

* 学习 Spring Cloud 微服务框架
* 学习 微服务相关知识
* 学习 Redis、Kafka 等中间件的使用

### 项目介绍

基于 SpringCloud 微服务框架下实现的优惠券系统，实现了多种优惠券的分发、核销、结算等功能。

按照优惠券的功能，将该系统分为模板、分发和结算三个微服务，分别提供创建优惠券模板、用户查找和分发优惠券、优惠券结算核销的功能服务。
每个服务功能是独立的，服务之间可以互相调用。

<figure>
    <img src="https://s1.ax1x.com/2023/08/08/pPVBBon.png" alt="rpc框架" style="zoom: 50%;">
    <figcaption>Fig 1. 项目框架.</figcaption>
</figure>

##### 模板微服务

由运营人员创建优惠券模板，之后再去生成对应数量的优惠券，最后用户才可以去领取优惠券。
这个模块（或者微服务）的核心功能都是围绕优惠券模板的。运营人员设定好条件（名称、logo、分类、产品线、数量、规则等等），后台异步创建优惠券模板。
之所以是异步过程，是因为创建优惠券模板的过程是比较耗时的，HTTP接口不返回是一种不好的用户体验。

生成优惠券码需要考虑两个方面：
* 不可以重复
* 有一定的识别性

**最终设计：由18位组成（前四位-产品线和类型 + 中间六位-日期 + 后八位-随机数）**

创建的优惠券模板不可能是一直有效的（模板一旦过期，它所对应的优惠券则不能再分发给用户。但是，已经分发给用户的，可以是不过期的），
所以，需要有一个过期机制能够让过期的优惠券不返回给用户展示。

这里借鉴 Redis 的过期策略，设计了两种实现策略：
* 优惠券模板模块中实现一个定时任务，例如每个小时运行一次，定时清理过期的优惠券模板
* 其他模块从模板模块获取优惠券模板时，自己去判断是否已经过期。之所以需要这样做，是因为定时任务总会存在一个定时间隔的延迟，并不能保证实时的过期

##### 分发微服务

总共涉及4个功能点的实现。

**根据用户id和优惠券状态查找用户优惠券记录**
1. 由于系统暂时没有接入用户系统，所以关于用户相关的创建、校验等功能暂时使用简单的fake进行代替；
2. 把属于用户的优惠券状态定义为三类：可用的、已使用和过期。过期是超出了优惠券的有效使用期，但是仍未被使用的；
3. 为了提升系统的响应速度，把用户的数据存储于Redis中，也就是与用户相关的优惠券信息都存储于Redis中；在展示用户数据的时候，将直接从Redis中读取；
4. 使用延迟处理的策略判断用户优惠券是否过期。也就是当用户查看自己优惠券的时候，判断是否存在过期的但是没有被标记的优惠券。如果存在，除了展示用户优惠券信息外，再做额外的过期处理。

**根据用户id查找当前可以领取的优惠券模板**
1. 优惠券模板是一个独立的服务，所以，分发模块需要通过微服务调用去获取模板数据。但是访问任何一个微服务都存在不确定性，所以，这里要有熔断兜底的策略； 
2. 从模板服务中获取到的优惠券模板，并不一定都是可领取的，需要去比对优惠券模板的相关限制。例如，有一张优惠券模板A，限制用户只能领取一张可用。那么，如果之前用户已经领取过了，且状态仍是可用状态，则这次就不能再次领取了。

**用户领取优惠券**
1. 由于需要通过微服务调用去获取模板数据，所以这里同样要有熔断兜底的策略；
2. 同样需要去比对优惠券模板的相关限制；
3. 由于每一张优惠券模板都要求它们所对应的优惠券要有优惠券码，且在生成的时候，直接放入到Redis中。所以，这里需要尝试从Redis中获取优惠券码； 
4. 通过了验证，即优惠券模板是可以领取的，且成功获取到了优惠券码，就可以将优惠券写入MySQL和Redis了。

**结算（核销）优惠券**
1. 无论是结算还是核销，都需要对前端传递的参数值进行校验，判断当前用户想要使用的优惠券是否是合法的，合法的标准是属于当前用户且优惠券的状态是可用；
2. 由于分发微服务直接面向用户，而结算实际只与优惠券模板定义的规则相关。所以，结算功能不放在分发微服务中，而是由优惠券系统中的第三个功能微服务负责，即结算微服务；
3. 结算和核销是两个不同的概念。结算是计算利用优惠券可以优惠的金额，但并不是使用。这种场景发生在付款之前，付款之前，优惠券并未使用，但是，也会显示使用优惠券之后优惠的金额和实际需要结算的金额。而核销则是使用优惠券。所以，对于核销这种情况，需要把数据回写到数据库中；

##### 结算微服务

结算微服务只提供一个功能：根据优惠券类型结算优惠券。 
1. 在设计优惠券的时候，会对优惠券设置不同的分类，例如：满减类、折扣类等；
2. 由于优惠券种类的不同，自然会有不同的结算方式，或者说结算的算法。例如，满减券是根据满多少金额减去多少金额，而折扣券是直接打一定的折扣等等。
3. 另外，更复杂的情况是优惠券之间可以组合。例如满减和折扣组合，先去满减，再去打一定的折扣。

### 数据库设计

##### MySQL 表设计

* **优惠券模板表：** 优惠券模板是与用户无关的，是对一类优惠券的描述。运营人员通过设定模板，来描述优惠券的各种信息。
<figure>
    <img src="https://s1.ax1x.com/2023/08/08/pPVsrFA.png" alt="优惠券模板表" style="zoom: 50%;">
    <figcaption>Fig 2. 优惠券模板表.</figcaption>
</figure>

* **用户优惠券表：** 优惠券模板是用来描述优惠券的，而优惠券表则是记录用户用户优惠券信息。这张表比较简单，除了主键之外，只有5个字段。
<figure>
    <img src="https://s1.ax1x.com/2023/08/08/pPVsBod.png" alt="用户优惠券表" style="zoom: 45%;">
    <figcaption>Fig 3. 用户优惠券表.</figcaption>
</figure>

##### 缓存设计

**优惠券码缓存**
* 使用Redis实现，KV类型的缓存；
* Key是需要有意义的，即最好能够根据Key来识别它对应的是什么数据。且需要注意，Redis这类基础工具往往是通用的，不要与其他的Key有冲突；
* 由于优惠券码需要一直保持在系统中，等待分发（即等待用户的领取），所以，并不设置过期时间。
* 为了保证优惠券码的Key不冲突，以前缀+主键的形式构成；且使用list类型（当然，使用set也是可以的）来保存优惠券码。

**用户优惠券信息缓存**
* 使用Redis实现，KV类型的缓存；
* Key是需要有意义的，即最好能够根据Key来识别它对应的是什么数据。且需要注意，Redis这类基础工具往往是通用的，不要与其他的Key有冲突；
* 由于优惠券分为3类，为了更加高效的检索，我这里的实现也会使用到三个缓存去实现。且由于每一类优惠券都可能是很多个，这里我选择使用Redis的hash类型；
* 由于用户数据量比较大，且在MySQL中保存有完整的用户信息。所以，不在Redis中长时间保留用户优惠券信息。需要设置一个过期时间。 
* 用户优惠券信息缓存的key是前缀+用户id的形式；value是hash类型，hash的key是优惠券id，hash的value是优惠券信息。
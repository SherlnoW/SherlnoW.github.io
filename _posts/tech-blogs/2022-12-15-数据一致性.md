---
layout: post
title: 数据一致性
date: 2022-12-15 13:00
description: 数据一致性
tag:
- redis
- mysql
- 缓存
---

# 什么是数据一致性
数据一致性是指在分布式系统中，当一个操作修改了数据副本的状态后，所有副本都应该能够达到相同的状态。

分布式系统中的数据一致性问题通常涉及到数据的复制和同步。当多个节点对同一份数据进行操作时，必须要保证最终所有节点上的副本都达到一致的状态。

# 什么是强一致性和弱一致性
在分布式系统中，强一致性和弱一致性是两种不同的一致性模型。

强一致性是指在分布式系统中，当一个操作完成后，所有节点上的副本都立即达到一致的状态。换句话说，强一致性保证任何时刻只有一个副本是可见的。

弱一致性是指在分布式系统中，当一个操作完成后，副本之间可能存在一段时间的不一致。弱一致性可以分为多种模型，如最终一致性、会话一致性等。

# 如何解决Redis缓存和MySQL的数据一致性
Redis是一种基于内存的高性能键值存储系统，而MySQL是一种关系型数据库。在使用Redis作为缓存时，保证Redis缓存和MySQL的数据一致性是一个常见的问题。

常见的缓存更新策略共有3种：

**Cache Aside（旁路缓存）策略**

适合读多写少的场景，不适合写多的场景，可以细分为「读策略」和「写策略」
* 写策略的步骤：

先更新数据库中的数据，再删除缓存中的数据。不能反过来，否则会出现缓存和数据库数据不一致的问题。

* 读策略的步骤：
1. 如果读取的数据命中了缓存，则直接返回数据； 
2. 如果读取的数据没有命中缓存，则从数据库中读取数据，然后将数据写入到缓存，并且返回给用户。

**Read/Write Through（读穿 / 写穿）策略**

只和缓存交互，不再和数据库交互，而是由缓存和数据库交互。使用本地缓存的时候可以考虑使用这种策略。 

* Read Through 策略: 先查询缓存中数据是否存在，如果存在则直接返回，如果不存在，则由缓存组件负责从数据库查询数据，并将结果写入到缓存组件，最后缓存组件将数据返回给应用。
* Write Through 策略: 当有数据更新的时候，先查询要写入的数据在缓存中是否已经存在： 

    * 如果缓存中数据已经存在，则更新缓存中的数据，并且由缓存组件同步更新到数据库中，然后缓存组件告知应用程序更新完成。 
    * 如果缓存中数据不存在，直接更新数据库，然后返回

**Write Back（写回）策略**

在更新数据的时候，只更新缓存，同时将缓存数据设置为脏的，然后立马返回，并不会更新数据库。数据库的更新会通过批量异步更新的方式进行。适合写多的场景，但有数据丢失的风险。
因为缓存一般使用内存，而内存是非持久化的，所以一旦缓存机器掉电，就会造成原本缓存中的脏数据丢失。

# 使用分布式锁实现数据的强一致性
分布式锁是一种常用的实现强一致性的方法。它可以确保同一时刻只有一个节点能够修改共享数据。

使用分布式锁实现数据的强一致性的一般步骤如下：

获取分布式锁：当一个节点需要修改数据时，首先尝试获取分布式锁。如果获取成功，则该节点可以执行修改操作；如果获取失败，则需要等待或重试。
执行修改操作：获取到分布式锁后，节点可以执行修改共享数据的操作。
释放分布式锁：当节点完成修改操作后，需要释放分布式锁，以便其他节点可以获取锁并执行修改操作。
使用分布式锁可以确保在分布式系统中数据的强一致性，但需要注意锁的获取和释放必须正确处理，避免死锁和资源竞争问题。
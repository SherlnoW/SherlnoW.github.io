---
layout: post
title: 【笔记】CAP
date: 2022-11-30
description: CAP
tag:
- RPC
- CAP
---

# 什么是CAP

CAP原则是指分布式系统设计时无法同时满足一致性（Consistency）、可用性（Availability）和分区容错性（Partition tolerance）这三个要求。
其中，一致性表示数据副本在多个节点上是否保持一致，可用性表示系统是否对外提供服务，分区容错性表示系统能否继续运行在面临网络分区的情况下。

根据CAP原则，我们需要在设计分布式系统时根据实际需求做出取舍。例如，在某些场景下，我们可能会选择保证一致性和可用性而放弃分区容错性；
而在另一些场景下，我们可能会更注重分区容错性，牺牲一致性或可用性。

* **一致性（Consistency）**: 数据在分布式系统中的副本必须保持一致，即任何时刻对数据的操作都必须得到相同的结果。
* **可用性（Availability）**: 系统必须一直处于可用状态，即对于任何请求都能够及时响应。
* **分区容错性（Partition tolerance）**: 系统要能够容忍网络故障导致的分区问题，即系统中的不同节点之间可能发生通信故障，但系统仍然能够正常运行。

# 分布式数据一致性协议

在分布式系统中，为了保证数据的高可用，通常会将数据保留多个副本，这些副本会放置在不同的物理机器上。为了为用户提供正确的信息，需要保证这些副本是一致的。

### Base理论

对CAP中一致性和可用性权衡的结果，来源于对大型互联网分布式实践的总结，是基于CAP定理逐步演化来的，
其核心思想是：虽然无法做到强制一致性，但每个应用都可以根据自身的业务特点，采用适当的方式来使系统达到最终一致性。

Base来自Basically Available(基本可用)，Soft state（软状态）和 Eventually consistent（最终一致性）的缩写。
* 基本可用：系统出现了不可预知的故障，但还能用，相较于正常系统有响应时间和功能上的损失。
* 软状态：允许系统中的数据存在中间状态，并认为该状态不影响系统的整体可用性，即允许系统在多个不同节点的数据副本存在数据延时。
* 最终一致性：超过软状态的时间期限后，应当保证所有副本保持数据一致性，从而达到数据的最终一致性。时间期限取决于网络延时、系统负载、数据复制方案设计等因素。

### 解决方案
为解决分布式一致性问题，比较著名的有二阶段提交协议（2PC）、三阶段提交协议（3PC）和Paxos算法。

**2PC**

引入一个协调者来统一掌控所有节点（参与者）的操作结果，并最终指示这些节点是否要把操作结果进行真正的提交。
即参与者将操作成败通知协调者，再由协调者根据所有参与者的反馈情报决定各参与者是否要提交操作还是终止操作。 若有一个参与者操作失败或通知超时，协调者则会给每个参与者发送回滚通知，否则发送提交消息。参与者会在完成后发送给协调者一个 ACK。协调者收到所有 ACK 后完成事务或取消事务。
缺点：
* 当协调者发送提交后宕机，第一个接收到提交指令的参与者同时也宕机，此时即使选举出了新的协调者，也无法得知事务是否已完成，因为 ACK 信号无法确认。
* 执行过程中，所有参与节点都是事务阻塞性的，当参与者占有公共资源时，其他第三方节点访问公共资源也会阻塞。

**3PC**

3PC将阶段一"提交事务请求"分成两部分，总共形成了3部分：

1. **Can Commit（非阻塞）**: 协调者通知所有参与者是否可以 Commit，参与者反馈是否可以。不涉及占用资源，只是检查。
2. **Pre Commit**: 若所有参与者均可以，则协调者发送相关指令，参与者收到指令后进行本地事务执行，记录日志，并将处理结果反馈到协调者来做决策。这个过程参与者可能成功或失败。
若存在参与者不可以，则协调者发送信号给所有参与者，告知本次事务取消。
3. **Do Commit**: 若 Pre Commit 后参与者全部完成本地事务执行但没提交，并都回复协调者ACK，则协调者向参与者发送提交指令，参与者收到后开始执行本地提交，并反馈结果，最终完成此次事务。
若协调者在 Pre Commit 收到参与者反馈后，发现存在部分参与者无法执行事务的情况，就告知其它参与者本地回滚，释放资源，取消本次事务。

相较于2PC，3PC主要解决单点故障问题，并减少阻塞。当参与者等待 Pre Commit 超时，参与者中断事务，继续之前的事情；当参与者等待 Do Commit 超时，则就本地执行提交完成此次事务；当协调者等待反馈超时时，将进行中断或回滚操作。
但3PC仍存在数据不一致问题，根源在于参与者超时机制。当在参与者收到 preCommit 请求后等待 doCommit 指令时，此时如果协调者请求中断事务，而协调者因为网络问题无法与参与者正常通信，会导致参与者继续提交事务，造成数据不一致。
无论2PC还是3PC都无法彻底解决分布式一致性问题。只有一种一致性算法，即Paxos算法。

**Paxos算法**

Basic Paxos算法中，有3种角色：
* 提议者（Proposer）：也可以叫做协调者（coordinator），提议者负责接受客户端的请求并发起提案。提案信息通常包括提案编号 (Proposal ID) 和提议的值 (Value)。
* 接受者（Acceptor）：也可以叫做投票员（voter），负责对提议者的提案进行投票，同时需要记住自己的投票历史；
* 学习者（Learner）：如果有超过半数接受者就某个提议达成了共识，那么学习者就需要接受这个提议，并就该提议作出运算，然后将运算结果返回给客户端。
为了减少实现该算法所需的节点数，一个节点可以身兼多个角色。并且一个提案被选定需要被半数以上的 Acceptor 接受。这样，Basic Paxos 算法还具备容错性，在少于一半的节点出现故障时，集群仍能正常工作。
Basic Paxos 算法仅能就单个值达成共识。而对于一系列值达成共识，需要用到 Multi Paxos 思想。比较著名的实现如 Raft 算法。

**TCC**

补偿事务，相当于应用层的 2PC，核心思想是：针对每个操作都要注册一个与其对应的确认和补偿。分为三个操作：
1. Try：负责资源的检查和预留，当 Try 阶段能正常预留资源，那 Confirm 一定能完整正确提交；当 Try 存在服务执行失败，就进入 Cancel 阶段。 
2. Confirm：提交操作，执行真正的业务； 
3. Cancel：预留资源的取消。